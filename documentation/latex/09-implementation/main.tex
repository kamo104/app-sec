% Implementation Details - Code examples and implementation specifics
\section{Implementation Details}

This section provides implementation details including code examples and the client generation process.

\subsection{User Interface}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{09-implementation/registration-form.png}
    \caption{Registration form with real-time field validation. Shows username, email, and password fields with immediate feedback on input validity using WASM-based validation.}
    \label{fig:registration-form}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{09-implementation/password-strength.png}
    \caption{Password strength indicator showing the 0--7 score system. Visual feedback updates in real-time as the user types, displaying strength level (weak/medium/strong/cia) and specific requirements not yet met.}
    \label{fig:password-strength}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{09-implementation/registration-success.png}
    \caption{Successful registration confirmation message. Informs the user that a verification email has been sent and provides next steps.}
    \label{fig:registration-success}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{09-implementation/email-verification.png}
    \caption{Email verification page showing successful account activation. Displayed after the user clicks the verification link from their email.}
    \label{fig:email-verification}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{09-implementation/validation-errors.png}
    \caption{Form displaying validation errors with translated messages. Shows field-specific error messages generated by the WASM translator module.}
    \label{fig:validation-errors}
\end{figure}

\subsection{Frontend Client Generation}

The build script (\texttt{build.sh}) fetches the OpenAPI spec from the running backend:

\begin{verbatim}
curl -s http://localhost:4000/api/openapi.json \
  > frontend/src/generated/openapi.json
\end{verbatim}

TypeScript client is generated using \texttt{@hey-api/openapi-ts}:

\begin{verbatim}
npx @hey-api/openapi-ts \
  --input src/generated/openapi.json \
  --output src/generated/api-client \
  --client @hey-api/client-fetch
\end{verbatim}

Generated files in \texttt{frontend/src/generated/api-client/}:
\begin{itemize}[leftmargin=*,nosep]
  \item \texttt{types.gen.ts}: All TypeScript interfaces (\texttt{RegistrationRequest}, \texttt{LoginResponse}, etc.)
  \item \texttt{sdk.gen.ts}: Typed API functions (\texttt{registerUser()}, \texttt{verifyEmail()}, etc.)
  \item \texttt{index.ts}: Re-exports for convenient imports
\end{itemize}

Client configured in \texttt{frontend/src/api/client.ts} with base URL and credentials.

\subsection{Registration Flow Implementation}

Frontend registration call (\texttt{frontend/src/pages/register.vue}):

\begin{lstlisting}[language=Java]
import { registerUser } from '@/generated/api-client';

const { data, error, response } = await registerUser({
  body: {
    username: formData.username,
    email: formData.email,
    password: formData.password,
  }
});

if (response.ok) {
  // Show translated success message
  statusMessage.value = translate('SUCCESS_REGISTERED', undefined);
} else if (error) {
  // Handle specific error codes
  if (error.error === 'USERNAME_TAKEN') {
    statusMessage.value = translate_error_code('USERNAME_TAKEN', undefined);
  } else if (error.error === 'VALIDATION') {
    // Display field-specific errors
    error.validation?.fieldErrors.forEach(fieldError => {
      fieldError.errors.forEach(code => {
        const msg = translate_field_validation_error(
          fieldError.field, code, undefined
        );
      });
    });
  }
}
\end{lstlisting}

\subsection{Email Verification Implementation}

Frontend verification (\texttt{frontend/src/pages/verify-email.vue}):

\begin{lstlisting}[language=Java]
import { verifyEmail } from '@/generated/api-client';

// Extract token from URL query parameter
const route = useRoute();
const token = route.query.token as string;

if (!token) {
  // Show warning: no token provided
  return;
}

const { data, error, response } = await verifyEmail({
  body: { token }
});

if (response.ok) {
  // Show success, navigate to login
  statusMessage.value = translate('SUCCESS_EMAIL_VERIFIED', undefined);
} else {
  // Show error (TOKEN_EXPIRED or INTERNAL)
  statusMessage.value = translate_error_code(error.error, undefined);
}
\end{lstlisting}

\subsection{Password Strength Validation}

Frontend password field uses detailed validation (\texttt{frontend/src/components/auth/PasswordField.vue}):

\begin{lstlisting}[language=Java]
import { validate_password_detailed } from '@/wasm/field-validator';

const result = JSON.parse(validate_password_detailed(password));

// result.score: 0-7 (based on length and character types)
// result.strength: "weak" | "medium" | "strong" | "cia"
// result.errors: ["TOO_SHORT", "TOO_FEW_UPPERCASE_LETTERS", ...]

// Score calculation:
// +1 for length >= 8
// +1 for length >= 12
// +1 for length >= 16
// +1 for uppercase letter
// +1 for lowercase letter
// +1 for digit
// +1 for special character
\end{lstlisting}

\subsection{Implementation Files}

\subsubsection{Backend Files}

\begin{itemize}[leftmargin=*,nosep]
  \item \texttt{backend/src/main.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Application entry point.
    \item Configures Axum router with API routes using \texttt{utoipa-axum}.
    \item Builds OpenAPI spec at runtime with \texttt{OpenApiRouter::with\_openapi()}.
    \item Mounts Swagger UI at \texttt{/api/docs} in dev mode.
    \item Initializes database connection and starts cleanup task.
  \end{itemize}
  \item \texttt{backend/src/api/register.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item \texttt{POST /api/register} handler with \texttt{\#[utoipa::path()]} annotation.
    \item Validates input, checks uniqueness, creates user.
    \item Generates verification token and sends email.
  \end{itemize}
  \item \texttt{backend/src/api/verify\_email.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item \texttt{POST /api/verify-email} handler with \texttt{\#[utoipa::path()]} annotation.
    \item Verifies token and marks user as verified.
  \end{itemize}
  \item \texttt{backend/src/api/utils.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Configuration constants from \texttt{build.rs}.
    \item Token duration settings, base URLs.
  \end{itemize}
  \item \texttt{backend/src/db/mod.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item \texttt{DBHandle} struct with connection pool.
    \item Password hashing with Argon2.
    \item Cleanup task for expired tokens.
  \end{itemize}
  \item \texttt{backend/src/db/user\_login.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item User table operations: create, lookup, verify.
  \end{itemize}
  \item \texttt{backend/src/db/user\_data.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item User data table operations.
  \end{itemize}
  \item \texttt{backend/src/db/email\_verification\_tokens.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Token table operations: create, lookup, delete.
  \end{itemize}
  \item \texttt{backend/src/email.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item SMTP email sending via \texttt{lettre}.
    \item Verification email template.
  \end{itemize}
\end{itemize}

\subsubsection{Frontend Files}

\begin{itemize}[leftmargin=*,nosep]
  \item \texttt{frontend/src/pages/register.vue}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Registration page with form.
    \item Uses generated \texttt{registerUser()} from API client.
    \item Real-time validation and error display.
  \end{itemize}
  \item \texttt{frontend/src/pages/verify-email.vue}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Email verification page.
    \item Uses generated \texttt{verifyEmail()} from API client.
    \item Extracts token from URL and calls API.
  \end{itemize}
  \item \texttt{frontend/src/components/auth/UsernameField.vue}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Username input with WASM validation.
  \end{itemize}
  \item \texttt{frontend/src/components/auth/EmailField.vue}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Email input with WASM validation.
  \end{itemize}
  \item \texttt{frontend/src/components/auth/PasswordField.vue}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Password input with strength indicator (0--7 score).
    \item WASM validation with detailed errors.
  \end{itemize}
  \item \texttt{frontend/src/components/auth/ConfirmPasswordField.vue}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Password confirmation with match validation.
  \end{itemize}
  \item \texttt{frontend/src/components/auth/AuthFormLayout.vue}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Common layout for auth forms.
  \end{itemize}
  \item \texttt{frontend/src/components/auth/StatusMessage.vue}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Success/error message display.
  \end{itemize}
  \item \texttt{frontend/src/api/client.ts}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item API client configuration (base URL, credentials).
    \item Re-exports generated API client for convenient imports.
  \end{itemize}
\end{itemize}

\subsubsection{Generated Files (Auto-Generated)}

\begin{itemize}[leftmargin=*,nosep]
  \item \texttt{frontend/src/generated/openapi.json}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item OpenAPI 3.1 specification fetched from backend.
    \item Source of truth for client generation.
  \end{itemize}
  \item \texttt{frontend/src/generated/api-client/types.gen.ts}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Auto-generated TypeScript interfaces from OpenAPI spec.
    \item Includes \texttt{RegistrationRequest}, \texttt{RegisterErrorResponse}, etc.
  \end{itemize}
  \item \texttt{frontend/src/generated/api-client/sdk.gen.ts}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Auto-generated typed API functions.
    \item Includes \texttt{registerUser()}, \texttt{verifyEmail()}, \texttt{healthCheck()}.
  \end{itemize}
  \item \texttt{frontend/src/generated/api-client/index.ts}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item Re-exports all generated types and functions.
  \end{itemize}
\end{itemize}

\subsubsection{Shared Crates}

\begin{itemize}[leftmargin=*,nosep]
  \item \texttt{api-types/src/}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item \texttt{requests.rs}: Request types with \texttt{ToSchema} derivation.
    \item \texttt{responses.rs}: Response and error types with \texttt{ToSchema} derivation.
    \item \texttt{validation.rs}: Validation data structures.
    \item \texttt{enums.rs}: \texttt{FieldType}, \texttt{ValidationErrorCode}, \texttt{PasswordStrength}.
    \item \texttt{Cargo.toml}: \texttt{openapi} feature flag for conditional \texttt{utoipa} support.
  \end{itemize}
  \item \texttt{field-validator/src/lib.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item \texttt{validate\_username()}, \texttt{validate\_email()}, \texttt{validate\_password()}
    \item \texttt{validate\_field()} -- WASM-exported wrapper
    \item \texttt{validate\_password\_detailed()} -- Returns strength score
  \end{itemize}
  \item \texttt{translator/src/lib.rs}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item \texttt{translate()}, \texttt{translate\_error\_code()}
    \item \texttt{translate\_field\_validation\_error()}
  \end{itemize}
  \item \texttt{translator/locales/en.yml}
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item English translations for all error codes and messages.
  \end{itemize}
\end{itemize}

\subsubsection{Build and Configuration Files}

\begin{itemize}[leftmargin=*,nosep]
  \item \texttt{build.sh} -- Main build script (WASM, backend, OpenAPI, frontend)
  \item \texttt{dev.sh} -- Development mode launcher
  \item \texttt{Dockerfile} -- Container build configuration
  \item \texttt{backend/.env} -- Environment variables (token durations, base URLs)
  \item \texttt{backend/build.rs} -- Compile-time constant generation
  \item \texttt{Cargo.toml} -- Workspace with utoipa dependencies
  \item \texttt{frontend/package.json} -- NPM scripts including \texttt{generate:api}
\end{itemize}
