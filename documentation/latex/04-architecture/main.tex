% Component Architecture - Technology stack, high-level diagram, data flow
\section{Component Architecture}

\subsection{Technology Stack}

\subsubsection*{Frontend}

\begin{itemize}[leftmargin=*,nosep]
  \item Vue~3 with TypeScript
  \item Vuetify for UI components
  \item Pinia for state management
  \item \texttt{@hey-api/openapi-ts} for automatic TypeScript client generation from OpenAPI spec
  \item \texttt{@hey-api/client-fetch} as the generated client's HTTP layer
  \item WASM modules for validation (\texttt{field-validator}) and translation (\texttt{translator})
\end{itemize}

\subsubsection*{Backend}

\begin{itemize}[leftmargin=*,nosep]
  \item Rust with Axum web framework
  \item Tokio async runtime
  \item \texttt{utoipa} for OpenAPI 3.1 specification generation
  \item \texttt{utoipa-axum} for automatic route documentation
  \item \texttt{utoipa-swagger-ui} for interactive API documentation (dev mode)
  \item SQLx for asynchronous database access
  \item SQLite with SQLCipher encryption
  \item Argon2 for password hashing (\texttt{argon2} crate)
  \item SHA256 for token hashing (\texttt{sha2} crate)
  \item \texttt{rand} for cryptographically secure random values
  \item \texttt{lettre} for SMTP email sending
\end{itemize}

\subsubsection*{Shared Components}

\begin{itemize}[leftmargin=*,nosep]
  \item \texttt{api-types}: Request/response types with conditional \texttt{ToSchema} derivation for OpenAPI
  \item \texttt{field-validator}: Validation logic (compiled to native and WASM)
  \item \texttt{translator}: Error message translation with \texttt{rust-i18n}
  \item Serde for serialization/deserialization
  \item wasm-pack for WASM module compilation
\end{itemize}

\subsubsection*{Database}

\begin{itemize}[leftmargin=*,nosep]
  \item SQLite database (\texttt{data.db} encrypted, \texttt{data\_dev.db} unencrypted)
  \item SQLCipher encryption with 32-byte key
  \item Key stored in system keyring or \texttt{APPSEC\_DB\_KEY} environment variable
  \item Foreign keys enabled with CASCADE delete
\end{itemize}

\subsection{OpenAPI and Client Generation}

The project uses a type-safe API contract approach where the backend serves as the single source of truth for API definitions.

\subsubsection*{Backend OpenAPI Generation (utoipa)}

\begin{itemize}[leftmargin=*,nosep]
  \item All API endpoints are documented using \texttt{\#[utoipa::path()]} proc macro.
  \item Request/response types derive \texttt{ToSchema} via feature flag: \texttt{\#[cfg\_attr(feature = "openapi", derive(ToSchema))]}.
  \item OpenAPI spec is generated at runtime using \texttt{OpenApiRouter::with\_openapi()}.
  \item In development mode (\texttt{--dev} flag):
  \begin{itemize}[leftmargin=1.5em,nosep]
    \item OpenAPI JSON available at \texttt{/api/openapi.json}
    \item Swagger UI available at \texttt{/api/docs}
  \end{itemize}
  \item Endpoints are organized into tags: \texttt{health}, \texttt{auth}, \texttt{counter}.
\end{itemize}

\subsubsection*{Benefits of This Approach}

\begin{itemize}[leftmargin=*,nosep]
  \item \textbf{Single source of truth}: API contract defined once in Rust, consumed everywhere.
  \item \textbf{Type safety}: TypeScript types auto-generated, compile-time API contract validation.
  \item \textbf{No manual synchronization}: Changes to backend API automatically propagate to frontend types.
  \item \textbf{Interactive documentation}: Swagger UI for API exploration and testing.
  \item \textbf{Reduced boilerplate}: No manual API client code or type definitions needed.
\end{itemize}

\subsection{High-Level Architecture Diagram}

\begin{verbatim}
+-------------------------------------------------------------+
|                     Frontend (Vue 3)                        |
|                                                             |
|   +-------------+   +--------------+   +----------------+   |
|   | Register    |-->| WASM         |-->| API Client     |   |
|   | Page        |   | Validators   |   | (TypeScript)   |   |
|   +-------------+   +--------------+   +----------------+   |
+-------------------------------------------------------------+
              |
              | HTTP/HTTPS
              v
+-------------------------------------------------------------+
|                      Backend (Axum)                         |
|                                                             |
|   +-------------+   +--------------+   +----------------+   |
|   | API         |   | Validation   |   | Email          |   |
|   | Handlers    |   | + Hashing    |   | Service        |   |
|   +-------------+   +--------------+   +----------------+   |
+-------------------------------------------------------------+
                             |
                             | SQL (SQLCipher)
                             v
+-------------------------------------------------------------+
|                     Database (SQLite)                       |
|                                                             |
|   +-------------+   +----------------------+                |
|   | user_login  |<--| email_verification   |                |
|   +-------------+   | _tokens              |                |
|         |           +----------------------+                |
|         v                                                   |
|   +-------------+                                           |
|   | user_data   |                                           |
|   +-------------+                                           |
+-------------------------------------------------------------+
\end{verbatim}
