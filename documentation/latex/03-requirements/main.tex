% Component Requirements - Functional and non-functional requirements
\section{Component Requirements}

\subsection{Functional Requirements}

\subsubsection{FR-1: User Registration}

\textbf{ID}: FR-1

\textbf{Description}: The system must allow a new user to register with username, email, and password.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item The frontend provides a registration form with real-time validation.
  \item Username must be 3--20 characters, printable UTF-8 only.
  \item Email must be valid format.
  \item Password must be 8--64 characters with uppercase, lowercase, digit, and special character.
  \item Returns specific error codes for duplicate username/email and validation failures.
\end{itemize}

\subsubsection{FR-2: Email Verification}

\textbf{ID}: FR-2

\textbf{Description}: The system must require email verification before the account is active.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item On successful registration, a secure verification token is generated.
  \item Token hash is stored in database (plaintext never stored).
  \item Verification email sent via SMTP with verification link.
  \item Token has configurable expiry.
  \item Verification endpoint validates token and marks user as verified.
  \item Token is deleted after successful verification.
\end{itemize}

\subsubsection{FR-3: Input Validation}

\textbf{ID}: FR-3

\textbf{Description}: All registration inputs must be validated on both frontend and backend.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item Shared validation logic compiled to WASM for frontend use.
  \item Username: 3--20 characters, printable UTF-8.
  \item Email: Valid format.
  \item Password: 8--64 characters with complexity requirements.
  \item Password strength score calculated with visual indicator.
  \item Validation errors translated to user-friendly messages.
\end{itemize}

\subsubsection{FR-4: Error Handling}

\textbf{ID}: FR-4

\textbf{Description}: The system must provide clear, translated error messages.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item Error responses use typed error codes.
  \item Validation errors include field-specific error codes.
  \item All error codes translated with localization support.
  \item Server errors logged internally; clients receive generic error.
\end{itemize}

\subsubsection{FR-5: Token Lifecycle}

\textbf{ID}: FR-5

\textbf{Description}: Verification tokens must be single-use and time-limited.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item Each user can have only one active verification token.
  \item Tokens expire after configurable duration.
  \item Expired tokens are automatically cleaned up.
  \item Unverified users with expired tokens are deleted.
  \item Token is deleted upon successful verification.
\end{itemize}

\subsubsection{FR-6: User Login}

\textbf{ID}: FR-6

\textbf{Description}: The system must allow verified users to log in with username and password.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item Login form accepts username and password.
  \item System validates username format before database lookup.
  \item Password is verified against Argon2 hash in database.
  \item Login is rejected if email is not verified.
  \item On success, a session token is generated and stored as HTTP-only cookie.
  \item Login response includes session expiry and user info.
\end{itemize}

\subsubsection{FR-7: Session Management}

\textbf{ID}: FR-7

\textbf{Description}: The system must manage user sessions securely.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item Sessions are stored server-side with token hash as primary key.
  \item Session tokens are 32 bytes of cryptographically secure random data.
  \item Cookies are HTTP-only, Secure (in production), SameSite=Strict.
  \item Session duration is configurable (default: 7 days).
  \item Frontend can check session validity via \texttt{GET /api/auth/check}.
  \item Frontend can refresh session via \texttt{POST /api/auth/refresh}.
  \item Expired sessions are automatically cleaned up hourly.
\end{itemize}

\subsubsection{FR-8: User Logout}

\textbf{ID}: FR-8

\textbf{Description}: The system must allow users to log out and destroy their session.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item Logout endpoint deletes session from database.
  \item Session cookie is cleared by setting expired cookie.
  \item Logout always returns success (idempotent).
\end{itemize}

\subsubsection{FR-9: Password Reset Request}

\textbf{ID}: FR-9

\textbf{Description}: The system must allow users to request a password reset via email.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item User provides email address to request password reset.
  \item System always returns success to prevent email enumeration.
  \item If email exists, a reset token is generated and emailed.
  \item Reset token hash is stored in database.
  \item Password reset flag is set on user account.
  \item Reset tokens have configurable expiry.
\end{itemize}

\subsubsection{FR-10: Password Reset Completion}

\textbf{ID}: FR-10

\textbf{Description}: The system must allow users to set a new password using a valid reset token.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item User provides reset token and new password.
  \item System validates token exists and is not expired.
  \item New password is validated against password policy.
  \item Password is hashed and stored.
  \item Reset token is deleted after successful reset.
  \item Password reset flag is cleared on user account.
\end{itemize}

\subsection{Non-Functional Requirements}

\subsubsection{NFR-1: Security}

\textbf{ID}: NFR-1

\textbf{Description}: All security best practices must be followed.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item Passwords hashed with memory-hard Argon2 algorithm.
  \item All tokens (verification, session, reset) stored as SHA256 hashes only.
  \item Database encrypted at rest with SQLCipher.
  \item HTTPS enforced in production.
  \item Session cookies are HTTP-only and Secure.
  \item Input validated on both frontend and backend.
  \item Password reset prevents email enumeration.
\end{itemize}

\subsubsection{NFR-2: Reliability}

\textbf{ID}: NFR-2

\textbf{Description}: The module must be fault-tolerant.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item On email sending failure, user record is rolled back.
  \item Foreign keys ensure referential integrity.
  \item Automatic cleanup of expired tokens and sessions.
  \item Session refresh extends validity without requiring re-login.
\end{itemize}

\subsubsection{NFR-3: Usability}

\textbf{ID}: NFR-3

\textbf{Description}: The module must provide clear user feedback.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item Real-time field validation on frontend.
  \item Password strength indicator.
  \item Translated error messages for all validation failures.
  \item Clear success/error states on all pages.
  \item Automatic session refresh in background.
\end{itemize}

\subsubsection{NFR-4: Performance}

\textbf{ID}: NFR-4

\textbf{Description}: The module must perform efficiently.

\textbf{Details}:
\begin{itemize}[leftmargin=*,nosep]
  \item Session lookup by token hash is O(1) via primary key.
  \item Cleanup tasks run hourly to prevent table bloat.
  \item WASM validation runs client-side to reduce server load.
  \item Session refresh uses existing token (no new token generation).
\end{itemize}
